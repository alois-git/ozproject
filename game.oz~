functor
import
   Gui
   Utils
   End
export
   Game
define
   % Constants

   fun {Game InitMap InitPlayers}

      fun {Inbox State Msg}
         case State of state(Map Players Playing) then
            case Msg of start then
		{Utils.printf "start"}
            [] stop then
               {End.endApp}
               state(stopped)
            [] move(Id NewP Dir) then
               Obj = {Gui.getAt Map NewP.x NewP.y}
            	in
               if {Label Players.Id} == dead then
                  {Send Players.Id.port invalid(dead Players.Id.pos)}
                  State
               end
            [] dead(Id) then
                  {Utils.printf "You have been killed"}
               end
         [] state(stopped) then
            state(stopped)
         end
      end
   in
      {Utils.newPortObject state(InitMap InitPlayers 0) Inbox}
   end
end
